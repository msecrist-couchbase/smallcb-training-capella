<style>
#playBox {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  width: 470px;
  padding: 0 1rem 0 0.5rem;
  background-color: white;
  color: #555;
  font-size: .75rem;
  white-space: nowrap;
  z-index: 11000;
}
#playBox button.playBoxExtrasToggle {
  display: none;
  height: 1rem;
  min-width: 4rem;
  margin: 1px 0.5rem;
  padding: 0 0.2rem;
  line-height: 1rem;
  font-size: 0.5rem;
}
#playBox button.playBoxExtrasToggle.playBoxShow {
  display: inline-block;
}
#playBox .playBoxExtras {
  display: none;
  position: absolute;
  top: 1.1rem;
  left: 5px;
  min-width: 25rem;
  max-width: 50vw;
  max-height: 90vh;
  border: 1px solid #aaa;
  background-color: white;
  padding: 0 0;
  overflow: hidden;
}
#playBox .playBoxExtras.playBoxShow {
  display: block;
}
#playBox .playBoxExtrasMain {
  height: 100%;
  padding: 1rem 1rem;
  overflow: scroll;
}
#playBox .playBoxExtrasMain .playBoxExtrasCard h3 a {
  margin-left: 6px;
  font-size: 8pt;
}
#playBox .playBoxExtrasMain .playBoxExtrasCard h4 {
  margin-left: 4px;
  font-size: 10pt;
}
#playBox .playBoxExtrasMain .playBoxExtrasCard pre {
  margin-left: 8px;
  font-size: 8pt;
}
body.modal-open .panel.dialog .panel-footer a.playBoxAPIHelp {
  flex-grow: 100;
  margin-left: 0.5rem;
}
</style>
<script type="text/javascript">
var playBoxPaths;

(function () {
  var checkPlayLoginN = 0;

  function checkPlayLogin() {
    checkPlayLoginN += 1;
    if (checkPlayLoginN > 100) {
      return;
    }

    var params = new URLSearchParams(document.location.search.substring(1));

    var lu = params.get("lu");
    var lp = params.get("lp");

    if (lu != "" && lp != "") {
      var eu = document.getElementById("auth-username-input");
      if (eu && eu.value == "") {
        var ep = document.getElementById("auth-password-input");
        if (ep && ep.value == "") {
          eu.value = lu;
          ep.value = lp;

          // Poke angularJS event handlers.
          eu.dispatchEvent(new InputEvent("input"));
          ep.dispatchEvent(new InputEvent("input"));

          return;
        }
      }

      setTimeout(checkPlayLogin, 200);
    }
  }

  // -------------------------------------------

  function createPlayBox() {
    if (!document.body) { return; }

    var el = document.createElement("div");

    el.id = el.className = "playBox";

    el.innerHTML =
      {{if .SessionId}}
        '<a href="http://{{.Host}}:{{.PortApp}}/?s={{.SessionId}}" target="_blank">' +
          'Couchbase Playground</a>'
      {{else}}
        'Couchbase Playground'
      {{end}}
      + `<button id="playBoxExtrasToggle" class="playBoxExtrasToggle"
                 onclick="playBoxExtrasToggle()">API Help</button>
         <div id="playBoxExtras" class="playBoxExtras">
           <a class="ui-dialog-titlebar-close modal-close"
              onclick="playBoxExtrasToggle()">X</a>
           <div class="panel-header">
             <h2>Couchbase Playground API Help</h2>
           </div>
           <div id="playBoxExtrasMain" class="playBoxExtrasMain"/>
         </div>`;

    document.body.appendChild(el);

    setTimeout(checkPlayLogin, 200);

    setTimeout(checkAPIHelp, 2500);
  }

  // -------------------------------------------

  var checkPlayBoxN = 0;

  function checkPlayBox() {
    checkPlayBoxN += 1;
    if (checkPlayBoxN > 20) {
      return;
    }

    var el = document.getElementById("playBox");
    if (!el) {
      createPlayBox();
    }

    setTimeout(checkPlayBox, 500);
  }

  checkPlayBox();

  // -------------------------------------------

  var paths = {{.inject_data}}; // Keyed by location hash prefix.

  playBoxPaths = paths; // Global for debugging.

  // -------------------------------------------

  function checkAPIHelp() {
    // Ex: #/overview/stats?scenarioBucket=beer-sample&scenarioZoom=minute&statsHostname=all
    var hashParts = window.location.hash.slice(2).split(/[\?\&]/);

    var keys = [];
    for (let p of hashParts) {
      keys.push(p.split('=')[0]);
    }

    var pbem = document.getElementById("playBoxExtrasMain");

    for (let path of (paths[keys[0]] || [])) {
      for (let title of (path.titles || [])) {
        var a = [];

        var matches = document.querySelectorAll(title.querySelectorAll);

        for (let x of matches) {
          if (title.check) {
            var ctx = { path: path, title: title, x: x, o: null };

            with (ctx) eval('o = ' + title.check);

            if (!ctx.o) {
              continue;
            }
          }

          for (let kind of (title.kinds || [])) {
            var ctx = {
              path: path, title: title, kind: kind, x: x, o: null,
              q: function(s) { return document.querySelector(s); },
              HOST: "hostname", USER: "Administrator", PSWD: "password"
            }

            with (ctx) eval('o = `' + kind.tmpl + '`');

            a.push(`<div>
                      <h4>${kind.kind}</h4>
                      ${kind.extra || ''}
                      <pre>${ctx.o}</pre>
                    </div>`);
          }
        }

        if (a.length > 0) {
          function docs(href) {
            return href ? `<a href="${href}" target="_blank">documentation</a>` : "";
          }

          pbem.innerHTML =
            `<div class="playBoxExtrasCard">
               <h3>
                 ${title.title}
                 ${docs(title.docs)}
               </h3>
               ${title.extra || ''}
               ${a.join('')}
             </div>`;

          document.getElementById("playBoxExtrasToggle").className = "playBoxExtrasToggle playBoxShow";

	  var c = document.querySelector('body.modal-open .panel.dialog .panel-footer a[ng-click="$dismiss()"]');
	  if (c && c.innerText.trim() == "Cancel" && !c.previousElementSibling) {
            var h = document.createElement("a");

            h.onclick = playBoxExtrasToggle;
            h.className = "playBoxAPIHelp";
            h.innerText = "API Help";

            c.parentNode.insertBefore(h, c);
          }

          setTimeout(checkAPIHelp, 1000);

          return;
        }
      }
    }

    pbem.innerHTML =
      `<div class="playBoxExtrasCard">
        No API Help available for this feature
       </div>`;

    document.getElementById("playBoxExtrasToggle").className = "playBoxExtrasToggle";

    document.getElementById("playBoxExtras").className = "playBoxExtras";

    setTimeout(checkAPIHelp, 1000);
  }
})()

function playBoxExtrasToggle() {
  var el = document.getElementById("playBoxExtras");
  if (el.className == "playBoxExtras") {
    el.className = "playBoxExtras playBoxShow";
  } else {
    el.className = "playBoxExtras";
  }
}
</script>
