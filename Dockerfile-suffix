# Copy init-couchbase files into image.

RUN mkdir -p /init-couchbase
COPY init-couchbase /init-couchbase
RUN chmod +x /init-couchbase/*.sh

# Copy play-server's run-*.sh files into image.

COPY cmd/play-server/run-*.sh /
RUN chmod +x /run-*.sh

# Create the play user for user-submitted playground code.

RUN useradd -u 1001 -g couchbase -m play

# SDK installs that need a non-root user will use the play user.

# ------------------------------------------------
# SDK nodejs

USER play

RUN echo "prefix = /home/play/npm_packages" >> ~/.npmrc && \
    PATH=/home/play/npm-packages/bin:$PATH \
    NODE_PATH=/home/play/npm-packages/lib/node_modules:$NODE_PATH \
    NPM_PACKAGES=/home/play/npm-packages \
    npm install -g couchbase ottoman gritty

USER root

RUN npm show couchbase | grep latest | cut -f 2 -d ' ' > /opt/couchbase/VERSION-sdk-nodejs.ver

# ------------------------------------------------
# SDK java

# Copy maven shared files and build hello.java to warm up mvn caches.

COPY --from=maven /usr/share/maven /usr/share/maven

RUN ln -s /usr/share/maven/bin/mvn /usr/bin/mvn

COPY cmd/play-server/run-java-pom.xml /run-java-pom.xml

COPY cmd/play-server/run-java-hello.java /home/play/hello/src/main/java/hello.java

RUN chown -R play:couchbase /home/play

USER play

RUN cp /run-java-pom.xml /home/play/hello/pom.xml && \
    cd /home/play/hello && \
    mvn package && \
    mvn dependency:build-classpath -Dmdep.outputFile=classpath.txt

USER root

RUN cat /run-java-pom.xml | grep 'version>3' | cut -f 2 -d '>' | cut -f 1 -d '<' > /opt/couchbase/VERSION-sdk-java.ver

# ------------------------------------------------
# SDK .NET

COPY cmd/play-server/run-csharp-hello.csproj /home/play/hellodotnet/run-csharp-hello.csproj

COPY cmd/play-server/run-csharp-hello.cs /home/play/hellodotnet/run-csharp-hello.cs

RUN chown -R play:couchbase /home/play

USER play

RUN cd /home/play/hellodotnet && \
    dotnet build

USER root

RUN tr ' ' '\n' < /home/play/hellodotnet/run-csharp-hello.csproj | grep Version | cut -f 2 -d '"' > /opt/couchbase/VERSION-sdk-dotnet.ver
